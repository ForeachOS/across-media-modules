<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.foreach.imageserver.dao.VariantImageDao">

    <sql id="variantImageColumns">
        V.id as variant_id,
        V.imageid as variant_imageid,
        V.formatid as variant_formatid,
        V.cropid as variant_cropid,
        V.width as variant_width,
        V.height as variant_height,
        V.version as variant_version,
        V.dateLastCalled as variant_dateLastCalled,
        V.dateCreated as variant_dateCreated
    </sql>

    <resultMap id="variantImageMap" type="VariantImage">
        <id property="id" column="variant_id"/>
        <result property="imageId" column="variant_imageid"/>
        <result property="formatId" column="variant_formatid"/>
        <result property="cropId" column="variant_cropid"/>
        <result property="version" column="variant_version"/>
        <result property="width" column="variant_width"/>
        <result property="height" column="variant_height"/>
        <result property="dateCreated" column="variant_dateCreated"/>
        <result property="lastCalled" column="variant_dateLastCalled"/>
    </resultMap>

    <select id="getVariantImageById" parameterType="long" resultMap="variantImageMap">
        SELECT
        <include refid="variantImageColumns"/>
        FROM Variant V
        WHERE V.id = #{value}
    </select>

    <select id="getVariantImage" parameterType="VariantImageSelector" resultMap="variantImageMap">
		SELECT
        <include refid="variantImageColumns"/>
        FROM Variant V
		<where>
			<if test="imageId != null">
				imageid = #{imageId}
			</if>
			<if test="height != null">
				AND height = #{height}
			</if>
            <if test="width != null">
				AND width = #{width}
			</if>
            <if test="version != null">
				AND version = #{version}
			</if>
		</where>
	</select>

    <select id="getVariantImages" parameterType="VariantImageSelector" resultMap="variantImageMap">
		SELECT
        <include refid="variantImageColumns"/>
        FROM Variant V
		<where>
			<if test="height != null">
				AND height = #{height}
			</if>
            <if test="width != null">
				AND width = #{width}
			</if>
            <if test="version != null">
				AND version = #{version}
			</if>
            <if test="calledAfterThisDate != null">
				AND dateLastCalled >= #{calledAfterThisDate}
			</if>
		</where>
        ORDER BY variant_dateLastCalled DESC
	</select>

    <select id="getAllVariantsForImage" parameterType="long" resultMap="variantImageMap">
        SELECT
        <include refid="variantImageColumns"/>
        FROM Variant V
        WHERE V.imageid = #{value}
        ORDER BY variant_dateLastCalled ASC
    </select>

    <insert id="insertVariantImage" parameterType="VariantImage" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO Variant (
            imageid,
            formatid,
            cropid,
            width,
            height,
            version,
            dateLastCalled
        ) VALUES (
            #{imageId},
            #{formatId},
            #{cropId},
            #{width},
            #{height},
            #{version},
            #{lastCalled}
        )
    </insert>

    <update id="updateVariantImage" parameterType="VariantImage">
        UPDATE Variant
        SET
            imageid = #{imageId},
            formatid = #{formatId},
            cropid = #{cropId},
            width = #{width},
            height = #{height},
            dateLastCalled = #{lastCalled},
            version = #{version}
        WHERE id = #{id} OR
        ( imageid = #{imageId} AND width = #{width} AND height = #{height} AND version = #{version} )
    </update>

    <update id="updateVariantImageDate" parameterType="VariantImage">
        UPDATE Variant
        SET
            dateLastCalled = #{lastCalled}
        WHERE id = #{id} OR
        ( imageid = #{imageId} AND width = #{width} AND height = #{height} AND version = #{version} )
    </update>

    <delete id="deleteVariantImage" parameterType="VariantImage">
        DELETE
        FROM Variant
        WHERE id = #{id} OR
        ( imageid = #{imageId} AND width = #{width} AND height = #{height} AND version = #{version} )
    </delete>

    <delete id="deleteVariantImages" parameterType="VariantImageSelector" >
		DELETE
        FROM Variant
		<where>
			<if test="height != null">
				height = #{height}
			</if>
            <if test="width != null">
				AND width = #{width}
			</if>
            <if test="version != null">
				AND version = #{version}
			</if>
            <if test="calledAfterThisDate != null">
				AND dateLastCalled >= #{calledAfterThisDate}
			</if>
            <if test="formatId != null">
				AND formatid >= #{formatId}
			</if>
		</where>
	</delete>

</mapper>