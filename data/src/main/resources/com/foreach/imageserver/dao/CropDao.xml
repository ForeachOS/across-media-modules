<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.foreach.imageserver.dao.CropDao">

    <sql id="cropColumns">
        C.id AS crop_id,
        C.imageid AS crop_imageid,
        C.version AS crop_version,
        C.originX AS crop_originx,
        C.originY AS crop_originy,
        C.width AS crop_width,
        C.height AS crop_height,
        C.ratioheight AS crop_ratioheight,
        C.ratiowidth AS crop_ratiowidth,
        C.targetwidth AS crop_targetwidth
    </sql>

    <resultMap id="cropMap" type="Crop">
        <id property="id" column="crop_id"/>
        <result property="imageId" column="crop_imageid"/>
        <result property="version" column="crop_version"/>
        <result property="ratioWidth" column="crop_ratiowidth"/>
        <result property="ratioHeight" column="crop_ratioheight"/>
        <result property="targetWidth" column="crop_targetwidth"/>
        <association column="crop_id" property="cropRect" javaType="Rect">
            <constructor>
                <arg column="crop_originx" javaType="_int"/>
                <arg column="crop_originy" javaType="_int"/>
                <arg column="crop_width" javaType="_int"/>
                <arg column="crop_height" javaType="_int"/>
            </constructor>
        </association>
    </resultMap>

    <select id="getCropById" parameterType="long" resultMap="cropMap">
        SELECT
        <include refid="cropColumns"/>
        FROM Crop C
        WHERE C.id = #{value}
    </select>

    <select id="getCrops" parameterType="CropSelector" resultMap="cropMap">
        SELECT
        <include refid="cropColumns"/>
        FROM Crop C
        <where>
            <if test="imageId != null">
                imageid = #{imageId}
            </if>
            <if test="aspectRatio != null">
                AND ratiowidth = #{aspectRatio.numerator}
                AND ratioHeight = #{aspectRatio.denominator}
            </if>
            <if test="targetWidth != null">
                AND targetwidth = #{targetWidth}
            </if>
            <if test="version != null">
                AND version = #{version}
            </if>
        </where>
    </select>

    <select id="getMaxVersion" parameterType="long" resultType="Integer">
        SELECT MAX(version)
        FROM Crop C
        WHERE C.imageid = #{value}
    </select>

    <insert id="insertCrop" parameterType="Crop" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO Crop (
            imageid,
            version,
            originX,
            originY,
            width,
            height,
            ratiowidth,
            ratioheight,
            targetwidth
        ) VALUES (
            #{imageId},
            #{version},
            #{cropRect.left},
            #{cropRect.top},
            #{cropRect.width},
            #{cropRect.height},
            #{ratioWidth},
            #{ratioHeight},
            #{targetWidth}
        )
    </insert>

    <update id="updateCrop" parameterType="Crop">
        UPDATE Crop
        SET
            imageid = #{imageId},
            version = #{version},
            originX = #{cropRect.left},
            originY = #{cropRect.top},
            width = #{cropRect.width},
            height = #{cropRect.height},
            ratiowidth = #{ratioWidth},
            ratioheight = #{ratioHeight},
            targetwidth = #{targetWidth}
        WHERE id = #{id}
    </update>

    <delete id="deleteCrop" parameterType="long">
        DELETE
        FROM Crop
        WHERE id = #{value}
    </delete>

	<delete id="deleteCropsForImage" parameterType="long">
	    DELETE
	    FROM Crop
	    WHERE imageid = #{value}
	</delete>


</mapper>