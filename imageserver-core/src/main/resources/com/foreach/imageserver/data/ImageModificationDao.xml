<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.foreach.imageserver.data.ImageModificationDao">

	<resultMap id="imageModificationMap" type="ImageModification">
		<id property="imageId" column="imageid"/>
		<id property="dimensions.width" column="savewidth"/>
		<id property="dimensions.height" column="saveheight"/>
		<result property="modifier.width" column="width"/>
		<result property="modifier.height" column="height"/>
		<result property="modifier.output" column="outputtype"
		        typeHandler="com.foreach.imageserver.data.handlers.ImageTypeHandler"/>
		<result property="modifier.crop.x" column="cropx"/>
		<result property="modifier.crop.y" column="cropy"/>
		<result property="modifier.crop.width" column="cropwidth"/>
		<result property="modifier.crop.height" column="cropheight"/>
		<result property="modifier.crop.sourceWidth" column="cropsourcewidth"/>
		<result property="modifier.crop.sourceHeight" column="cropsourceheight"/>
		<result property="modifier.density.width" column="densityx"/>
		<result property="modifier.density.height" column="densityy"/>
		<result property="modifier.stretch" column="stretch"/>
		<result property="modifier.keepAspect" column="keepaspect"/>
		<result property="dateCreated" column="created"/>
		<result property="dateUpdated" column="updated"/>
	</resultMap>

	<select id="getModificationsForImage" parameterType="int" resultMap="imageModificationMap">
		SELECT *
		FROM imagemodification
		WHERE imageid = #{value}
		ORDER BY savewidth ASC, saveheight ASC
	</select>

	<select id="getModification" parameterType="map" resultMap="imageModificationMap">
		SELECT *
		FROM imagemodification
		WHERE imageid = #{imageId} AND savewidth = #{dimensions.width} AND saveheight = #{dimensions.height}
	</select>

	<insert id="insertModification" parameterType="ImageModification">
        INSERT INTO imagemodification (
            imageid, savewidth, saveheight, width, height, outputtype,
            cropx, cropy, cropwidth, cropheight, cropsourcewidth, cropsourceheight,
            densityx, densityy, stretch, keepaspect, created
        ) VALUES (
            #{imageId},
            #{dimensions.width},
            #{dimensions.height},
            #{modifier.width},
            #{modifier.height},
            #{modifier.output.id},
            #{modifier.crop.x},
            #{modifier.crop.y},
            #{modifier.crop.width},
            #{modifier.crop.height},
            #{modifier.crop.sourceWidth},
            #{modifier.crop.sourceHeight},
            #{modifier.density.width},
            #{modifier.density.height},
            #{modifier.stretch},
            #{modifier.keepAspect},
            GETDATE()
        )
    </insert>

	<update id="updateModification" parameterType="ImageModification">
        UPDATE imagemodification
        SET
        	width = #{modifier.width},
        	height = #{modifier.height},
            outputtype = #{modifier.output.id},
			cropx = #{modifier.crop.x},
			cropy = #{modifier.crop.y},
			cropwidth = #{modifier.crop.width},
			cropheight = #{modifier.crop.height},
			cropsourcewidth = #{modifier.crop.sourceWidth},
			cropsourceheight = #{modifier.crop.sourceHeight},
			densityx = #{modifier.density.width},
			densityy = #{modifier.density.height},
			stretch = #{modifier.stretch},
			keepaspect = #{modifier.keepAspect},
            updated = GETDATE()
        WHERE imageid = #{imageId} AND savewidth = #{dimensions.width} AND saveheight = #{dimensions.height}
    </update>

	<delete id="deleteModification" parameterType="map">
		DELETE FROM imagemodification
	    WHERE imageid = #{imageId} AND savewidth = #{dimensions.width} AND saveheight = #{dimensions.height}
	</delete>
</mapper>