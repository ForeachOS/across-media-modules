<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.foreach.imageserver.core.data.ImageVariantDao">

    <resultMap id="imageModificationMap" type="StoredImageVariant">
        <id property="imageId" column="imageid"/>
        <result property="variant.modifier.width" column="width"/>
        <result property="variant.modifier.height" column="height"/>
        <result property="variant.modifier.output" column="outputtype"
                typeHandler="com.foreach.imageserver.core.data.handlers.ImageTypeHandler"/>
        <result property="variant.crop.x" column="cropx"/>
        <result property="variant.crop.y" column="cropy"/>
        <result property="variant.crop.width" column="cropwidth"/>
        <result property="variant.crop.height" column="cropheight"/>
        <result property="variant.crop.sourceWidth" column="cropsourcewidth"/>
        <result property="variant.crop.sourceHeight" column="cropsourceheight"/>
        <result property="variant.modifier.density.width" column="densityx"/>
        <result property="variant.modifier.density.height" column="densityy"/>
        <result property="variant.modifier.stretch" column="stretch"/>
        <result property="variant.modifier.keepAspect" column="keepaspect"/>
        <result property="dateCreated" column="created"/>
        <result property="dateUpdated" column="updated"/>
    </resultMap>

    <select id="getVariantsForImage" parameterType="int" resultMap="imageModificationMap">
		SELECT *
		FROM imagemodification
		WHERE imageid = #{value}
		ORDER BY width ASC, height ASC
	</select>

    <select id="getVariant" parameterType="map" resultMap="imageModificationMap">
		SELECT *
		FROM imagemodification
		WHERE imageid = #{imageId} AND width = #{modifier.width} AND height = #{modifier.height}
		<!-- TODO: Add more parameters from the modifier in the select clause ? -->
	</select>

    <insert id="insertVariant" parameterType="StoredImageVariant">
        INSERT INTO imagemodification (
            imageid, width, height, outputtype, densityx, densityy, stretch, keepaspect,
            cropx, cropy, cropwidth, cropheight, cropsourcewidth, cropsourceheight,
            created
        ) VALUES (
            #{imageId},
            #{variant.modifier.width},
            #{variant.modifier.height},
            #{variant.modifier.output.id},
            #{variant.modifier.density.width},
            #{variant.modifier.density.height},
            #{variant.modifier.stretch},
            #{variant.modifier.keepAspect},
            #{variant.crop.x},
            #{variant.crop.y},
            #{variant.crop.width},
            #{variant.crop.height},
            #{variant.crop.sourceWidth},
            #{variant.crop.sourceHeight},
            GETDATE()
        )
    </insert>

    <update id="updateVariant" parameterType="StoredImageVariant">
        UPDATE imagemodification
        SET
        	outputtype = #{variant.modifier.output.id},
			densityx = #{variant.modifier.density.width},
			densityy = #{variant.modifier.density.height},
			stretch = #{variant.modifier.stretch},
			keepaspect = #{variant.modifier.keepAspect},
			cropx = #{variant.crop.x},
			cropy = #{variant.crop.y},
			cropwidth = #{variant.crop.width},
			cropheight = #{variant.crop.height},
			cropsourcewidth = #{variant.crop.sourceWidth},
			cropsourceheight = #{variant.crop.sourceHeight},
            updated = GETDATE()
        WHERE imageid = #{imageId} AND width = #{variant.modifier.width} AND height = #{variant.modifier.height}
    </update>

    <delete id="deleteVariant" parameterType="map">
		DELETE FROM imagemodification
	    WHERE imageid = #{imageId} AND width = #{variant.modifier.width} AND height = #{variant.modifier.height}
	</delete>
</mapper>