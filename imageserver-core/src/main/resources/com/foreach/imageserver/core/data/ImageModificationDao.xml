<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.foreach.imageserver.core.data.ImageModificationDao">

    <sql id="columns">
		IM.imageId as image_id,
		IM.contextId as context_id,
        IM.resolutionId as resolution_id,
        IM.densityWidth as density_width,
        IM.densityHeight as density_height,
        IM.cropX as crop_x,
        IM.cropY as crop_y,
        IM.cropWidth as crop_width,
        IM.cropHeight as crop_height
	</sql>

    <resultMap id="imageModificationMap" type="ImageModification">
        <id property="imageId" column="image_id"/>
        <id property="contextId" column="context_id"/>
        <id property="resolutionId" column="resolution_id"/>
        <result property="density.width" column="density_width"/>
        <result property="density.height" column="density_height"/>
        <result property="crop.x" column="crop_x"/>
        <result property="crop.y" column="crop_y"/>
        <result property="crop.width" column="crop_width"/>
        <result property="crop.height" column="crop_height"/>
    </resultMap>

    <select id="getById" parameterType="map" resultMap="imageModificationMap">
        SELECT
        <include refid="columns"/>
        FROM IMAGE_MODIFICATION IM
        WHERE IM.imageId = #{imageId} AND IM.contextId = #{contextId} AND IM.resolutionId = #{imageResolutionId}
    </select>

    <select id="getModifications" parameterType="map" resultMap="imageModificationMap">
        SELECT
        <include refid="columns"/>
        FROM IMAGE_MODIFICATION IM
        WHERE IM.imageId = #{imageId} AND IM.contextId = #{contextId}
    </select>

    <select id="getAllModifications" parameterType="map" resultMap="imageModificationMap">
        SELECT
        <include refid="columns"/>
        FROM IMAGE_MODIFICATION IM
        WHERE IM.imageId = #{imageId}
    </select>

    <insert id="insert" parameterType="ImageModification">
        INSERT INTO IMAGE_MODIFICATION (
          imageId,
          contextId,
          resolutionId,
          densityWidth,
          densityHeight,
          cropX,
          cropY,
          cropWidth,
          cropHeight
        ) VALUES (
          #{imageId},
          #{contextId},
          #{resolutionId},
          #{density.width},
          #{density.height},
          #{crop.x},
          #{crop.y},
          #{crop.width},
          #{crop.height}
        )
    </insert>

    <update id="update" parameterType="ImageModification">
        UPDATE IMAGE_MODIFICATION
        SET
            densityWidth = #{density.width},
            densityHeight = #{density.height},
            cropX = #{crop.x},
            cropY = #{crop.y},
            cropWidth = #{crop.width},
            cropHeight = #{crop.height}
        WHERE imageId = #{imageId} AND contextId = #{contextId} AND resolutionId = #{resolutionId}
    </update>

    <select id="hasModification" parameterType="int" resultType="boolean">
        SELECT CASE WHEN EXISTS (
          SELECT 1 FROM IMAGE_MODIFICATION IM WHERE IM.imageId = #{value}
        ) THEN 1 ELSE 0 END
        FROM DUAL
    </select>

</mapper>