<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.foreach.imageserver.core.data.ImageResolutionDao">

    <sql id="columns">
		IR.id as ir_id,
        IR.width as ir_width,
        IR.height as ir_height,
        IR.configurable as ir_configurable,
        IR.name as ir_name,
        IR.tags as ir_tags
	</sql>

    <resultMap id="imageResolutionMap" type="ImageResolution">
        <id property="id" column="ir_id"/>
        <result property="width" column="ir_width"/>
        <result property="height" column="ir_height"/>
        <result property="configurable" column="ir_configurable"/>
        <result property="name" column="ir_name"/>
        <result property="tags" column="ir_tags"
                typeHandler="com.foreach.imageserver.core.data.handlers.StringToSetHandler"/>
    </resultMap>

    <select id="getById" parameterType="int" resultMap="imageResolutionMap">
        SELECT
        <include refid="columns"/>
        FROM IMAGE_RESOLUTION IR
        WHERE IR.id = #{value}
    </select>

    <select id="getForContext" parameterType="map" resultMap="imageResolutionMap">
        SELECT
        <include refid="columns"/>
        FROM CONTEXT_IMAGE_RESOLUTION CIR
        LEFT JOIN IMAGE_RESOLUTION IR ON IR.id = CIR.imageResolutionId
        WHERE CIR.contextId = #{contextId}
        ORDER BY IR.width ASC, IR.height ASC
    </select>

    <select id="getAllResolutions" resultMap="imageResolutionMap">
        SELECT
        <include refid="columns"/>
        FROM IMAGE_RESOLUTION IR
        ORDER BY IR.width ASC, IR.height ASC
    </select>

    <insert id="insertResolution" parameterType="ImageResolution">
        <selectKey keyProperty="id" resultType="int" order="BEFORE">
            SELECT SEQ_IMAGE_RESOLUTION.nextval AS ID FROM DUAL
        </selectKey>
        INSERT INTO IMAGE_RESOLUTION (id, width, height, configurable, name, tags)
        VALUES (#{id}, #{width,jdbcType=INTEGER}, #{height,jdbcType=INTEGER}, #{configurable}, #{name},
        #{tags, typeHandler=com.foreach.imageserver.core.data.handlers.StringToSetHandler})
    </insert>

    <update id="updateResolution" parameterType="ImageResolution">
        UPDATE IMAGE_RESOLUTION
        SET width = #{width,jdbcType=INTEGER},
          height = #{height,jdbcType=INTEGER},
          configurable = #{configurable},
          name = #{name},
          tags = #{tags, typeHandler=com.foreach.imageserver.core.data.handlers.StringToSetHandler}
        WHERE id = #{id}
    </update>
</mapper>
